<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>http://my.cyanzoy.top</id>
    <title>MAOA-L</title>
    <updated>2019-09-19T06:58:43.715Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="http://my.cyanzoy.top"/>
    <link rel="self" href="http://my.cyanzoy.top/atom.xml"/>
    <subtitle>ä¸ºæŠ€æœ¯è€Œç”Ÿ</subtitle>
    <logo>http://my.cyanzoy.top/images/avatar.png</logo>
    <icon>http://my.cyanzoy.top/favicon.ico</icon>
    <rights>All rights reserved 2019, MAOA-L</rights>
    <entry>
        <title type="html"><![CDATA[åç«¯å¿…å¤‡ Nginx é…ç½®]]></title>
        <id>http://my.cyanzoy.top/post/9XwZQILat</id>
        <link href="http://my.cyanzoy.top/post/9XwZQILat">
        </link>
        <updated>2019-09-19T02:55:54.000Z</updated>
        <summary type="html"><![CDATA[<ul>
<li>é˜²ç›—é“¾</li>
<li>æ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®è¿‡æœŸæ—¶é—´</li>
<li>é™æ€èµ„æºè®¿é—®</li>
<li>æ—¥å¿—é…ç½®</li>
<li>æ—¥å¿—å­—æ®µè¯´æ˜</li>
<li>access_log è®¿é—®æ—¥å¿—</li>
<li>error_log æ—¥å¿—</li>
<li>æ—¥å¿—åˆ‡å‰²</li>
<li>åå‘ä»£ç†</li>
<li>ç¦æ­¢æŒ‡å®šuser_agent</li>
<li>nginxè®¿é—®æ§åˆ¶</li>
<li>è´Ÿè½½å‡è¡¡</li>
</ul>
]]></summary>
        <content type="html"><![CDATA[<ul>
<li>é˜²ç›—é“¾</li>
<li>æ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®è¿‡æœŸæ—¶é—´</li>
<li>é™æ€èµ„æºè®¿é—®</li>
<li>æ—¥å¿—é…ç½®</li>
<li>æ—¥å¿—å­—æ®µè¯´æ˜</li>
<li>access_log è®¿é—®æ—¥å¿—</li>
<li>error_log æ—¥å¿—</li>
<li>æ—¥å¿—åˆ‡å‰²</li>
<li>åå‘ä»£ç†</li>
<li>ç¦æ­¢æŒ‡å®šuser_agent</li>
<li>nginxè®¿é—®æ§åˆ¶</li>
<li>è´Ÿè½½å‡è¡¡</li>
</ul>
<!-- more -->
<h2 id="é˜²ç›—é“¾">é˜²ç›—é“¾</h2>
<pre><code>location ~* \.(gif|jpg|png)$ {
    # åªå…è®¸ 192.168.0.1 è¯·æ±‚èµ„æº
    valid_referers none blocked 192.168.0.1;
    if ($invalid_referer) {
       rewrite ^/ http://$host/logo.png;
    }
}
</code></pre>
<h2 id="æ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®è¿‡æœŸæ—¶é—´">æ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®è¿‡æœŸæ—¶é—´</h2>
<pre><code>location ~.*\.css$ {
    expires 1d;
    break;
}
location ~.*\.js$ {
    expires 1d;
    break;
}
location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$ {
    access_log off;
    expires 15d;    #ä¿å­˜15å¤©
    break;
}

# curl -x127.0.0.1:80 http://www.test.com/static/image/common/logo.png -I #
æµ‹è¯•å›¾ç‰‡çš„max-age
</code></pre>
<h2 id="é™æ€èµ„æºè®¿é—®">é™æ€èµ„æºè®¿é—®</h2>
<pre><code>http {
    # è¿™ä¸ªå°†ä¸ºæ‰“å¼€æ–‡ä»¶æŒ‡å®šç¼“å­˜ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰å¯ç”¨çš„ï¼Œmax æŒ‡å®šç¼“å­˜æ•°é‡ï¼Œ
    # å»ºè®®å’Œæ‰“å¼€æ–‡ä»¶æ•°ä¸€è‡´ï¼Œinactive æ˜¯æŒ‡ç»è¿‡å¤šé•¿æ—¶é—´æ–‡ä»¶æ²¡è¢«è¯·æ±‚ååˆ é™¤ç¼“å­˜ã€‚
    open_file_cache max=204800 inactive=20s;

    # open_file_cache æŒ‡ä»¤ä¸­çš„inactive å‚æ•°æ—¶é—´å†…æ–‡ä»¶çš„æœ€å°‘ä½¿ç”¨æ¬¡æ•°ï¼Œ
    # å¦‚æœè¶…è¿‡è¿™ä¸ªæ•°å­—ï¼Œæ–‡ä»¶æè¿°ç¬¦ä¸€ç›´æ˜¯åœ¨ç¼“å­˜ä¸­æ‰“å¼€çš„ï¼Œå¦‚ä¸Šä¾‹ï¼Œå¦‚æœæœ‰ä¸€ä¸ª
    # æ–‡ä»¶åœ¨inactive æ—¶é—´å†…ä¸€æ¬¡æ²¡è¢«ä½¿ç”¨ï¼Œå®ƒå°†è¢«ç§»é™¤ã€‚
    open_file_cache_min_uses 1;

    # è¿™ä¸ªæ˜¯æŒ‡å¤šé•¿æ—¶é—´æ£€æŸ¥ä¸€æ¬¡ç¼“å­˜çš„æœ‰æ•ˆä¿¡æ¯
    open_file_cache_valid 30s;

    # é»˜è®¤æƒ…å†µä¸‹ï¼ŒNginxçš„gzipå‹ç¼©æ˜¯å…³é—­çš„ï¼Œ gzipå‹ç¼©åŠŸèƒ½å°±æ˜¯å¯ä»¥è®©ä½ èŠ‚çœä¸
    # å°‘å¸¦å®½ï¼Œä½†æ˜¯ä¼šå¢åŠ æœåŠ¡å™¨CPUçš„å¼€é”€å“¦ï¼ŒNginxé»˜è®¤åªå¯¹text/htmlè¿›è¡Œå‹ç¼© ï¼Œ
    # å¦‚æœè¦å¯¹htmlä¹‹å¤–çš„å†…å®¹è¿›è¡Œå‹ç¼©ä¼ è¾“ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ¥è®¾ç½®ã€‚
    gzip on;
    gzip_min_length 1k;
    gzip_buffers 4 16k;
    gzip_http_version 1.0;
    gzip_comp_level 2;
    gzip_types text/plain application/x-javascript text/css application/xml;


    server {
        listen       80;
        server_name www.test.com;
        charset utf-8;
        root   /data/www.test.com;
        index  index.html index.htm;
    }
}
</code></pre>
<h2 id="æ—¥å¿—é…ç½®">æ—¥å¿—é…ç½®</h2>
<h3 id="æ—¥å¿—å­—æ®µè¯´æ˜">æ—¥å¿—å­—æ®µè¯´æ˜</h3>
<pre><code>remote_addr å’Œ http_x_forwarded_for â–¶ å®¢æˆ·ç«¯ IP åœ°å€
remote_user â–¶ å®¢æˆ·ç«¯ç”¨æˆ·åç§°
request â–¶ è¯·æ±‚çš„ URI å’Œ HTTP åè®®
status â–¶ è¯·æ±‚çŠ¶æ€
body_bytes_sent â–¶ è¿”å›ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°ï¼Œä¸åŒ…æ‹¬å“åº”å¤´çš„å¤§å°
bytes_sent â–¶ è¿”å›ç»™å®¢æˆ·ç«¯æ€»å­—èŠ‚æ•°
connection â–¶ è¿æ¥çš„åºåˆ—å·
connection_requests â–¶ å½“å‰åŒä¸€ä¸ª TCP è¿æ¥çš„çš„è¯·æ±‚æ•°é‡
msec â–¶ æ—¥å¿—å†™å…¥æ—¶é—´ã€‚å•ä½ä¸ºç§’ï¼Œç²¾åº¦æ˜¯æ¯«ç§’
pipe â–¶ å¦‚æœè¯·æ±‚æ˜¯é€šè¿‡HTTPæµæ°´çº¿(pipelined)å‘é€ï¼Œpipeå€¼ä¸º&quot;p&quot;ï¼Œå¦åˆ™ä¸º&quot;.&quot;
http_referer â–¶ è®°å½•ä»å“ªä¸ªé¡µé¢é“¾æ¥è®¿é—®è¿‡æ¥çš„
http_user_agent â–¶ è®°å½•å®¢æˆ·ç«¯æµè§ˆå™¨ç›¸å…³ä¿¡æ¯
request_length â–¶ è¯·æ±‚çš„é•¿åº¦(åŒ…æ‹¬è¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´å’Œè¯·æ±‚æ­£æ–‡)
time_iso8601 â–¶ ISO8601æ ‡å‡†æ ¼å¼ä¸‹çš„æœ¬åœ°æ—¶é—´
time_local â–¶ è®°å½•è®¿é—®æ—¶é—´ä¸æ—¶åŒº
</code></pre>
<h2 id="access_log-è®¿é—®æ—¥å¿—">access_log è®¿é—®æ—¥å¿—</h2>
<pre><code>http {
    log_format  access  '$remote_addr - $remote_user [$time_local] $host &quot;$request&quot; '
                  '$status $body_bytes_sent &quot;$http_referer&quot; '
                  '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &quot;$clientip&quot;';
    access_log  /srv/log/nginx/talk-fun.access.log  access;
}
</code></pre>
<h2 id="error_log-æ—¥å¿—">error_log æ—¥å¿—</h2>
<pre><code>error_log  /srv/log/nginx/nginx_error.log  error;
# error_log /dev/null; # çœŸæ­£çš„å…³é—­é”™è¯¯æ—¥å¿—
http {
    # ...
}
</code></pre>
<h2 id="æ—¥å¿—åˆ‡å‰²">æ—¥å¿—åˆ‡å‰²</h2>
<pre><code># å’Œapacheä¸åŒçš„æ˜¯ï¼Œnginxæ²¡æœ‰apacheä¸€æ ·çš„å·¥å…·åšåˆ‡å‰²ï¼Œéœ€è¦ç¼–å†™è„šæœ¬å®ç°ã€‚# åœ¨/usr/local/sbinä¸‹å†™è„šæœ¬

#!/bin/bash
dd=$(date -d '-1 day' +%F)[ -d /tmp/nginx_log ] || mkdir /tmp/nginx_log
mv /tmp/nginx_access.log /tmp/nginx_log/$dd.log
/etc/init.d/nginx reload &gt; /dev/null
</code></pre>
<h2 id="åå‘ä»£ç†">åå‘ä»£ç†</h2>
<pre><code>http {
    include mime.types;
    server_tokens off;

    ## é…ç½®åå‘ä»£ç†çš„å‚æ•°
    server {
        listen    8080;

        ## 1. ç”¨æˆ·è®¿é—® http://ip:portï¼Œåˆ™åå‘ä»£ç†åˆ° https://github.com
        location / {
            proxy_pass  https://github.com;
            proxy_redirect     off;
            proxy_set_header   Host             $host;
            proxy_set_header   X-Real-IP        $remote_addr;
            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        }

        ## 2.ç”¨æˆ·è®¿é—® http://ip:port/README.mdï¼Œåˆ™åå‘ä»£ç†åˆ°
        ##   https://github.com/zibinli/blog/blob/master/README.md
        location /README.md {
            proxy_set_header  X-Real-IP  $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass https://github.com/zibinli/blog/blob/master/README.md;
        }
    }
}
</code></pre>
<h2 id="ç¦æ­¢æŒ‡å®šuser_agent">ç¦æ­¢æŒ‡å®šuser_agent</h2>
<pre><code>#è™šæ‹Ÿä¸»æœºçš„é…ç½®æ–‡ä»¶é‡ŒåŠ å…¥ï¼š
if ($http_user_agent ~* 'baidu|360|sohu') #ç¦æ­¢useragentä¸ºbaiduã€360å’Œsohuï¼Œ~*è¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™åŒ¹é…
{
   return 403;
}

location /  å’Œ  location  ~ /  ä¼˜å…ˆçº§æ˜¯ä¸ä¸€æ ·çš„ã€‚ 
ç»“åˆè¿™ä¸ªæ–‡ç« ç ”ç©¶ä¸€ä¸‹å§ http://blog.itpub.net/27181165/viewspace-777202/
curl -A &quot;baidu&quot; -x127.0.0.1:80 www.test.com/forum.php -I    è¯¥å‘½ä»¤æŒ‡å®šç™¾åº¦ä¸ºuser_agent,è¿”å›403
</code></pre>
<h2 id="nginxè®¿é—®æ§åˆ¶">nginxè®¿é—®æ§åˆ¶</h2>
<pre><code># å¯ä»¥è®¾ç½®ä¸€äº›é…ç½®ç¦æ­¢ä¸€äº›ipçš„è®¿é—®

deny 127.0.0.1;     #å…¨å±€å®šä¹‰é™åˆ¶ï¼Œlocationé‡Œçš„æ˜¯å±€éƒ¨å®šä¹‰çš„ã€‚å¦‚æœä¸¤è€…å†²çªï¼Œä»¥locationè¿™ç§ç²¾ç¡®åœ°ä¼˜å…ˆï¼Œ

location ~ .*admin\.php$ {
    #auth_basic &quot;cct auth&quot;;
    #auth_basic_user_file /usr/local/nginx/conf/.htpasswd;

    allow 127.0.0.1;  åªå…è®¸127.0.0.1çš„è®¿é—®ï¼Œå…¶ä»–å‡æ‹’ç»
    deny all;

    include fastcgi_params;
    fastcgi_pass unix:/tmp/www.sock;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME /data/www$fastcgi_script_name;
}
</code></pre>
<h2 id="è´Ÿè½½å‡è¡¡">è´Ÿè½½å‡è¡¡</h2>
<pre><code>http {
    upstream test.net {
        ip_hash;
        server 192.168.10.13:80;
        server 192.168.10.14:80  down;
        server 192.168.10.15:8009  max_fails=3  fail_timeout=20s;
        server 192.168.10.16:8080;
    }
    server {
        location / {
            proxy_pass  http://test.net;
        }
    }
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[æ‰£å‡åº“å­˜]]></title>
        <id>http://my.cyanzoy.top/post/UL3LlJVMC</id>
        <link href="http://my.cyanzoy.top/post/UL3LlJVMC">
        </link>
        <updated>2019-09-18T03:24:31.000Z</updated>
        <content type="html"><![CDATA[<!-- more -->
<p>ä½¿ç”¨CAS, <code>update table set v_1 = aa where id = xx and v_1 = old_v_1</code></p>
<blockquote>
<p>CAS â˜ compare/check and swap/set</p>
</blockquote>
<p>ä¸Šé¢çš„æ–¹æ¡ˆ,å¯èƒ½ä¼šå‡ºç°ä¸€ä¸ªCASä¸­ç»å…¸é—®é¢˜. ABAçš„é—®é¢˜.</p>
<pre><code>ABAæ˜¯æŒ‡:
çº¿ç¨‹T1 æŸ¥è¯¢,åº“å­˜å‰©ä½™ Â 100
çº¿ç¨‹T2 æŸ¥è¯¢,åº“å­˜å‰©ä½™ Â 100
çº¿ç¨‹T1 æ‰§è¡Œsubupdate t set surplus = 90 where id = x and surplus = 100;
çº¿ç¨‹T3 æŸ¥è¯¢, åº“å­˜å‰©ä½™ 90
çº¿ç¨‹T3 æ‰§è¡Œadd Â update t set surplus = 100 where id = x and surplus = 90;
çº¿ç¨‹T2 æ‰§è¡Œsubupdate t set surplus = 90 where id = x and surplus = 100;
</code></pre>
<p>è¿™é‡Œçº¿ç¨‹T2æ‰§è¡Œçš„æ—¶å€™,åº“å­˜çš„100å·²ç»ä¸æ˜¯æŸ¥è¯¢åˆ°çš„100äº†<br>
ä¸€èˆ¬çš„è®¾è®¡ä¸­CASä¼šä½¿ç”¨versionæ¥æ§åˆ¶.</p>
<pre><code>update t set surplus = 90 ,version = version+1 where id = x and version = oldVersion;
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Git ç¬”è®°]]></title>
        <id>http://my.cyanzoy.top/post/git-bi-ji</id>
        <link href="http://my.cyanzoy.top/post/git-bi-ji">
        </link>
        <updated>2019-09-17T14:29:28.000Z</updated>
        <summary type="html"><![CDATA[<p>gitçš„ä¸€äº›å‘½ä»¤è®°å½•</p>
]]></summary>
        <content type="html"><![CDATA[<p>gitçš„ä¸€äº›å‘½ä»¤è®°å½•</p>
<!-- more -->
<p>ğŸ”¹Git æ·»åŠ è¿œç¨‹ä»“åº“å…³è”</p>
<pre><code>git remote add origin git@github.com:MAOA-L/AliPayApplet.git
git push -u origin master 
#è¿™å¥ä¸€èˆ¬ä¸ä¸Šå¥ä¸€èµ·ç”¨ã€‚ç”¨äºè¿œç¨‹ä»“åº“æ²¡æœ‰åˆå§‹åŒ–æ—¶
</code></pre>
<p>ğŸ”¸Git æœ¬åœ°åˆ†æ”¯å…³è”è¿œç¨‹åˆ†æ”¯</p>
<pre><code>git branch --set-upstream-to=origin/remote_branch  your_branch
</code></pre>
<p>ğŸ”¹Git åˆ é™¤æœ¬åœ°åˆ†æ”¯</p>
<pre><code>git branch -d [branchname]
</code></pre>
<p>ğŸ”¸Git åˆ é™¤è¿œç¨‹åˆ†æ”¯</p>
<pre><code>git push origin --delete [branchname]
</code></pre>
<blockquote>
<p><code>Q&amp;A</code><br>
Q: git branch ä¸æ˜¾ç¤ºåˆ†æ”¯åŸå› <br>
A: git branchè¦åœ¨git commitåæ‰ä¼šæ˜¾ç¤ºåˆ†æ”¯.</p>
</blockquote>
]]></content>
    </entry>
</feed>